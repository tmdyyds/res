## 问题

#### 如何避免长事务对业务的影响？

- 首先去掉事务中不必要的select

- 通过 SET MAX_EXECUTION_TIME 命令，来控制每个语句执行的最长时间

- 监控 information_schema.Innodb_trx 表，设置长事务阈值，超过就报警 / 或者 kill

- 其他 https://time.geekbang.org/column/article/69236

#### 优化sql中，出现 explain 的结果预估的 rows 值跟实际情况差距比较大，如何处理？

- analyze table t (线上低谷时期使用)

#### mysql选错索引如何处理？

- force index(A)

- 分解sql语句，拆分或子查询优化

- 新建合适索引或删除索引

#### 优化慢sql时候，注意优化器选择索引问题？

- 影响优化器选择索引三要素：扫描行数、是否使用临时表、是否排序

#### mysql长连接造成的OOM(现象重启)如何处理？

- 定期断开长连接，使用一段时间或程序里面判断执行一个占用内存的的大查询后，断开连接，之后要查询再重连
- mysql5.7以上，可以再每次执行一个比较大的操作后，执行**mysql_reset_connection**重新初始化连接，这个过程不需要重连和重新做权限验证，但是会将连接恢复到刚刚创建完时的状态

#### 为什么不建议使用长事务？

>  长事务意味着系统里面会存在很老的事务视图。 由于这些事务随时可能访问数据库里面的任何数据，所以这个**事务提交之前，数据库里面它可能用到的回滚记录都必须保留**，这就会导致**大量占用存储空间**。 除了对回滚段的影响，长事务还**占用锁资源**，也可能拖垮整个库

#### 如何安全地给小表加字段？

- 首先解决长事务，长事务会占用mdl读锁，产生大量undolog,占用大量资源。
- 对表结构修改的语句注意执行时间，长时间卡住需要注意先取消掉，避免影响其他线程对表的增删改查操作

#### MySQL是怎么保证数据不丢的？

> 只要 redo log 和 binlog 保证持久化到磁盘，就能确保 MySQL 异常重启后，数据可以恢复

#### 造成主备延迟的问题有哪些？

- 备库所在机器的性能要比主库所在的机器性能差，备库压力大，因为备库一般做select,外加同步binlog,造成cpu飙升
- 主库大事务，因为主库上必须等事务执行完成才会写入 binlog，再传给备库。所以，如果一个主库上的语句执行 10 分钟，那这个事务很可能就会导致从库延迟 10 分钟(例如 大量delete或大表DDL)